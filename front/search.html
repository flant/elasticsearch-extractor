<!doctype html>
<html>
<head>
<title>Elasticsearch: restore snapshots</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="stylesheet" href="/assets/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous"> 

<link href="/assets/css/docs.min.css" rel="stylesheet">

<style>
body {
  padding-top: 56px;
}
mark {
  background-color: #f0ed26;
}
</style>

</head>
<body>
<header>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">X-tractor</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav">
      <a class="nav-link" href="/#">Snapshots</span></a>
      <a class="nav-link active" href="/search/#">Searches</a>
    </div>
</nav>
</header>
  <!-- Page Content -->
  <div class="container-fluid">
    <div class="row flex-xl-nowrap">
        <div class="col-xl-2 bd-sidebar">
          <nav class="collapse bd-links" id="bd-docs-nav" aria-label="Main navigation">
            <div class="bd-search" style="position: relative; display: inline-block; left: 50px; direction: ltr;">
              <select class="form-control form-control-sm" id="clusters" style="width:90%">
                <option selected value=-1>Select...</option>
              </select>
              <select class="form-control form-control-sm" name="indices"  style="width:90%" id="igs">
                <option selected value=-1>Select...</option>
              </select>
            </div>
          <ul class="list-group" id="fields"></ul>
          </nav>
        </div> <!-- /.left -->
        <main class="col-xl-10 py-md-4 pl-md-2 bd-content" role="main">
          <form action="/api/" role="form" method="POST" id="update_form">
            <input type="hidden" name="action" value="search">
            <input type="hidden" name="idx" id="idx">
            <input type="hidden" name="cluster" id="cluster">
              <div class="form-row">
                <div class="col-8">
                  <input id="xql" type="text" class="form-control form-control-sm">
                </div>
                <div class="col">
                  <input id="datetimepicker_start" type="text" class="form-control form-control-sm mx-sm-1">
                </div>
                <div class="col">
                  <input id="datetimepicker_end" type="text" class="form-control form-control-sm mx-sm-1">
                </div>
                <div class="col">
                  <button type="button" class="btn btn-primary btn-sm" id="search">Search</button>
                </div>
              </div>
          </form>
          <div class="py-md-2"><a href="#"  data-target='#modal_add_filter' data-toggle='modal'>Add filter</a><span class="mb-2 overflow-auto" style="max-height: 1024px;" id="filters"> </span></div>
          <div class="d-flex align-items-center invisible" id="loading"><strong>Loading...</strong><div class="spinner-border ml-auto" role="status" aria-hidden="true"></div></div>
          <span class="mb-0 overflow-auto" style="max-height: 1024px;" id="result"> </span>
        </main><!-- /.main -->

    </div><!-- /.row -->
  </div><!-- /.container -->


      <div class="modal fade" tabindex="-1" id="modal_add_filter" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add filter</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form action="#" role="form" class="form-horizontal" method="POST" id="add_filter_form">
            <input type="hidden" class="form-control" id="add_filter_uuid">
            <div class="modal-body">
                <div class="form-row">
                  <div class="form-group col-md-9">
                    <label for="add_filter_fieldlist">Field</label>
                    <select id="add_filter_fieldlist" class="form-control">
                      <option selected>Select</option>
                    </select>
                  </div>
                  <div class="form-group col-md-3">
                    <label for="add_filter_operation">Value</label>
                      <select id="add_filter_operation" class="form-control">
                        <option selected>Select</option>
                      </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="add_filter_">Value</label>
                  <input type="text" class="form-control" id="add_filter_value" placeholder="Enter the value">
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="add_filter_save" data-dismiss="modal">Save</button>
            </div>
          </div>
          </form>
        </div>

      </div><!-- /.modal -->


      <div class="modal fade" tabindex="-1" id="modal_update_filter" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add filter</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form action="#" role="form" class="form-horizontal" method="POST" id="update_filter_form">
            <input type="hidden" class="form-control" id="update_filter_uuid">
            <div class="modal-body">
                <div class="form-row">
                  <div class="form-group col-md-9">
                    <label for="update_filter_fieldlist">Field</label>
                    <select id="update_filter_fieldlist" class="form-control">
                      <option selected>Select</option>
                    </select>
                  </div>
                  <div class="form-group col-md-3">
                    <label for="update_filter_operation">Value</label>
                      <select id="update_filter_operation" class="form-control">
                        <option selected>Select</option>
                      </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="update_filter_value">Value</label>
                  <input type="text" class="form-control" id="update_filter_value" placeholder="Enter the value">
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-warning" id="remove_filter" data-dismiss="modal">Remove</button>
              <button type="button" class="btn btn-primary" id="update_filter" data-dismiss="modal">Save</button>
            </div>
          </div>
          </form>
        </div>

      </div><!-- /.modal -->

</body>
<link rel="stylesheet" type="text/css" href="/assets/css/jquery.datetimepicker.min.css">
<script src="/assets/js/jquery-3.5.1.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/jquery.datetimepicker.full.min.js"></script>

<script>
const date = new Date();
var mapping = [];
var filter_operation = ["is", "is_not", "exists", "does_not_exists"]
var filters_set = {}
date.setMinutes(date.getMinutes() - 15)
$.datetimepicker.setLocale('ru');
$('#datetimepicker_start').datetimepicker({timepicker: true, format:'Y-m-d H:i:s', step: 15, value:date});
$('#datetimepicker_end').datetimepicker({
  timepicker: true, 
  format:'Y-m-d H:i:s', 
  step: 15,
  value:new Date(),
  onShow:function( ct ){
   this.setOptions({
    minDate:$('#datetimepicker_start').val()?$('#datetimepicker_start').val():false
   })
  }
});
//var getnodes = setInterval(NodeStatus, 5000);
//var getindices = setInterval(IndexList, 3000);

function bytesToSize(bytes) {
   var sizes = ['b', 'kb', 'mb', 'gb', 'tb'];
   if (bytes == 0) return '0 byte';
   var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
   return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
}

$(document).ready(function(){
    var post = {
      "action": "get_clusters"
    };

    $.ajax({
      type: "POST",
      url: "/api/",
      data: JSON.stringify(post),
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        var str = "";
        for(var k in data) {
          name = data[k].Name;
          host = data[k].Host;
          $('#clusters').append(new Option(name, host,true,true));
        }
        $("#loading").addClass('invisible');
    }
  });
});

$('#clusters').on('change', function(e) {
    var cluster = this.value;
    if (cluster!=-1) {
      var post = {
        "action": "get_index_groups",
        "values" : {
          "cluster": cluster
        }
      };
      $('#cluster').val(cluster);
      $('#igs').find('option')
      .remove()
      .end();
      $.ajax({
        type: "POST",
        url: "/api/",
        data: JSON.stringify(post),
        dataType: 'json',
        contentType: 'application/json',
        success: function (data) {
          var str = "";
          for(var k in data) {
            index = data[k].index;
            $('#igs').append(new Option(index, index,false,false));
          }
          $("#loading").addClass('invisible');
      }
    });
  }
});

$('#igs').on('change', function(e) {
      var post = {
        "action": "get_mapping",
        "values" : {
          "cluster": $('#cluster').val(),
          "index": $('#igs').val()
        }
      };
      $.ajax({
        type: "POST",
        url: "/api/",
        data: JSON.stringify(post),
        dataType: 'json',
        contentType: 'application/json',
        success: function (data) {
          var str = "";
          mapping = [];
          for (var k in data) {
            str += "<li class='list-group-item' style='word-wrap: break-word !important; word-break: break-word;'><input type='checkbox' name='fields' data-type='" + data[k] + "' value='" + k + "'>"+ k + "&nbsp;&nbsp;(" + data[k] + ")" +"</li>";
            mapping.push(k);
          }
          $("#fields").html(str);
          $("#loading").addClass('invisible');
      }
    });
});

$('#modal_add_filter').on('shown.bs.modal',function(e){

    $('#add_filter_fieldlist').find('option')
    .remove()
    .end();
    
    $('#add_filter_operation').find('option')
    .remove()
    .end();
    
    $('#add_filter_uuid').val((Math.random() + 1).toString(36).substring(7));
    
    $('#add_filter_fieldlist').append(new Option("Select...", "",true,true));
    for (k in mapping) {
          optText = mapping[k];
          optValue = mapping[k];
          $('#add_filter_fieldlist').append(new Option(optText, optValue,false,false));
    }
    
    $('#add_filter_operation').append(new Option("Select...", "",true,true));
    for (k in filter_operation) {
          optText = filter_operation[k];
          optValue = filter_operation[k];
          $('#add_filter_operation').append(new Option(optText, optValue,false,false));
    }

});

$("#add_filter_save").click(function(){
  var str = $("#filters").html();
  var btn_id = $("#add_filter_uuid").val()
  if ($("#add_filter_operation").val()=="is") {
    str += "<button type='button' id='" + $("#add_filter_uuid").val() + "' class='btn filter' data-target='#modal_update_filter' data-toggle='modal' data-uuid='" + $("#add_filter_uuid").val() + "' data-field='" + $("#add_filter_fieldlist").val() + "' data-oper='is' data-value='"+$("#add_filter_value").val()+"'>" + $("#add_filter_fieldlist").val() + ":" + $("#add_filter_value").val() + "</button>";
  } else if ($("#add_filter_operation").val()=="is_not") {
    str += "<button type='button' id='" + $("#add_filter_uuid").val() + "' class='btn filter' data-target='#modal_update_filter' data-toggle='modal' data-uuid='" + $("#add_filter_uuid").val() + "' data-field='" + $("#add_filter_fieldlist").val() + "' data-oper='is_not' data-value='"+$("#add_filter_value").val()+"'> NOT " + $("#add_filter_fieldlist").val() + ":" + $("#add_filter_value").val() + "</button>";
  } else if ($("#add_filter_operation").val()=="exists") {
    str += "<button type='button' id='" + $("#add_filter_uuid").val() + "' class='btn filter' data-target='#modal_update_filter' data-toggle='modal' data-uuid='" + $("#add_filter_uuid").val() + "' data-field='" + $("#add_filter_fieldlist").val() + "' data-oper='exists' data-value=''>" + $("#add_filter_fieldlist").val() + ": exists</button>";
  } else if ($("#add_filter_operation").val()=="does_not_exists") {
    str += "<button type='button' id='" + $("#add_filter_uuid").val() + "' class='btn filter' data-target='#modal_update_filter' data-toggle='modal' data-uuid='" + $("#add_filter_uuid").val() + "' data-field='" + $("#add_filter_fieldlist").val() + "' data-oper='does_not_exists' data-value=''>" + $("#add_filter_fieldlist").val() + ": not exists</button>";
  } 
  $("#filters").html(str);
  filters_set[btn_id] = {"field":$("#add_filter_fieldlist").val(), "operation": $("#add_filter_operation").val(), "value": $("#add_filter_value").val()};
  event.preventDefault();
});

$("#update_filter").click(function(){
  var btn_id = $("#update_filter_uuid").val()
  if ($("#update_filter_operation").val()=="is") {
    $("#"+btn_id).html($("#update_filter_fieldlist").val() + ":" + $("#update_filter_value").val())
    $("#"+btn_id).attr("data-value", $("#update_filter_value").val())
    $("#"+btn_id).attr("data-field", $("#update_filter_fieldlist").val())
    $("#"+btn_id).attr("data-oper", "is")
  } else if ($("#update_filter_operation").val()=="is_not") {
    $("#"+btn_id).html($("#update_filter_fieldlist").val() + ": not " + $("#update_filter_value").val())
    $("#"+btn_id).attr("data-value", $("#update_filter_value").val())
    $("#"+btn_id).attr("data-field", $("#update_filter_fieldlist").val())
    $("#"+btn_id).attr("data-oper", "is_not")
  } else if ($("#update_filter_operation").val()=="exists") {
    $("#"+btn_id).html($("#update_filter_fieldlist").val() + ": exists")
    $("#"+btn_id).attr("data-field", $("#update_filter_fieldlist").val())
    $("#"+btn_id).attr("data-value", "")
    $("#"+btn_id).attr("data-oper", "exists")
  } else if ($("#update_filter_operation").val()=="does_not_exists") {
    $("#"+btn_id).html($("#update_filter_fieldlist").val() + ": does_not_exists")
    $("#"+btn_id).attr("data-field", $("#update_filter_fieldlist").val())
    $("#"+btn_id).attr("data-value", "")
    $("#"+btn_id).attr("data-oper", "does_not_exists")
  }

  filters_set[btn_id] = {"field":$("#update_filter_fieldlist").val(), "operation": $("#update_filter_operation").val(), "value": $("#update_filter_value").val()};
  event.preventDefault();
});

$("#remove_filter").click(function(e){
  var btn_id = $("#update_filter_uuid").val()
  $("#"+btn_id).remove()
  delete filters_set[btn_id]
});

$("#filters").on("click", "button.filter", function(e){
    filter_btn = $(e.target)
    $('#update_filter_uuid').val(filter_btn.attr("data-uuid"))
    $('#update_filter_value').val(filter_btn.attr("data-value"))

    $('#update_filter_fieldlist').find('option')
    .remove()
    .end();

    $('#update_filter_operation').find('option')
    .remove()
    .end();

    for (k in mapping) {
      optText = mapping[k];
      optValue = mapping[k];
      if (optValue==filter_btn.attr("data-field")) {
        $('#update_filter_fieldlist').append(new Option(optText, optValue,true,true));
      } else {
        $('#update_filter_fieldlist').append(new Option(optText, optValue,false,false));
      }
    }

    for (k in filter_operation) {
          optText = filter_operation[k];
          optValue = filter_operation[k];
          if (optValue==filter_btn.attr("data-oper")) {
            $('#update_filter_operation').append(new Option(optText, optValue,true,true));
          } else {
            $('#update_filter_operation').append(new Option(optText, optValue,false,false));
          }
    }
});


$("#search").click(function(){
    $("#loading").removeClass('invisible');
    $("#result").html("");
    fields = []
    tf = []
    xql = $('#xql').val()
    $("input[name='fields']").each(function() {
      if (this.dataset.type=="date") {
        tf.push(this.value)
      }
      if (this.checked) {
        fields.push(this.value)
      }
    });

    var post = {
      "action": "search",
      "values" : {
        "index": $('#igs').val(),
        "fields": fields,
        "filters": filters_set,
        "timefields": tf,
        "cluster": $('#cluster').val(),
        "xql": xql,
        "date_start":$('#datetimepicker_start').val(),
        "date_end":$('#datetimepicker_end').val(),
      }
    };
    
    $.ajax({
      type: "POST",
      url: "/api/",
      data: JSON.stringify(post),
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        res = data.hits.hits
        var str = "";

        if ( res.length > 0 ) {
          str = "<table  class='table'><thead><tr><th>Time</th>";
            if ( fields.length == 0 ) {
              str+="<th>_source</th>";
            } else {
              for (var f in res[0].fields) {
                  if (f==tf[0]) {
                    continue;
                  } else {
                    str+="<th>" + f + "</th>";
                  }
                  
              }
            }
          str+="</tr></thead><tbody>";
          term = xql.replace(new RegExp(" ", "gi"), (match) => `|`);
          for (var k in res) {
            str += "<tr>";
            if ( fields.length == 0 ) {
              r = JSON.stringify(res[k]._source)
              s = r.replace(new RegExp(term, "gi"), (match) => `<mark>${match}</mark>`);
              str += "<td>"+ res[k]._source[tf[0]] +"</td>";
              str += "<td style='word-wrap: break-word !important; word-break: break-word;'>"+ s +"</td>";
            } else {
              str += "<td>"+ res[k].fields[tf[0]] +"</td>";
              for (var f in res[k].fields) {
                if (f==tf[0]) {
                   continue;
                } else {
                  r = res[k].fields[f].toString();
                  s = r.replace(new RegExp(term, "gi"), (match) => `<mark>${match}</mark>`);
                  str += "<td>" + s + "</td>";
                }
              }
            }
            str+="</tr>";
          }
          str+="</tbody></table>";
        } else {
          str = "<h3>No search results found</h3>";
        }
        $("#result").html(str);
      },
      error: function (data) {
        $("#result").html(data);
      }
    });
    $("#loading").addClass('invisible');
    //event.preventDefault();
});

$('#add_filter').on('hidden.bs.modal',function(){
	$('#add_filter_form').trigger('reset');
});
</script>

</html>
